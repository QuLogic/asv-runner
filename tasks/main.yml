---
- name: Setup Miniconda
  include_role:
    name: uchida.miniconda
    vars:
      name: asv
      channels:
        - conda-forge
      dependencies:
        - python=3.5
        - asv
        - pip

- name: Install system packages
  become: yes
  apt:
    name:
      - git
      - python-pip
    state: present
    update_cache: true
  tags:
    - packages

- name: Install system python packages
  become: yes
  pip:
    name:
      - boto
      - python-dateutil
      - boto3
  tags:
    - aws
    - s3

- name: Download repository
  git:
    repo: "{{ repo }}"
    dest: "{{ workdir }}"

- name: Copy machine info
  template:
    src: asv-machine.json.j2
    dest: /home/{{ ansible_user }}/.asv-machine.json

- name: Run benchmarks
  command: "{{ miniconda_dir }}/envs/asv/bin/asv run --machine={{ machine.name }}"
  args:
    chdir: "{{ workdir }}/{{ item }}"
  with_items:
    "{{ benchmark_roots }}"
  environment:
    PATH: "{{ ansible_env.PATH }}:{{ miniconda_dir }}/bin"
  tags:
    - benchmarks
